<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>Validate Invoice</title>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=Jura:wght@300..700&display=swap" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

        <style>
            :root {
                --primary-red: #f0f0f0;
                --primary-green: #4caf50;
                --form-gray: #f5f5f5;
                --toolbar-bg: #f0f0f0;
                --text-color: #333;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: "Jura", sans-serif;
            }

            body {
                background-color: var(--primary-red);
                height: 100svh;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
            .container {
                width: 100%;
                height: calc(100% - 50px);
                display: flex;
                flex-direction: column;
            }
            .toolbar {
                background-color: var(--toolbar-bg);
                padding: 5px;
                border-bottom: 1px solid #ddd;
                display: flex;
                gap: 5px;
                align-items: center;
                justify-content: space-between;
            }

            .toolbar button {
                background: none;
                border: none;
                cursor: pointer;
                padding: 5px 10px;
                font-size: 1rem;
                transition: opacity 0.3s;
                color: var(--text-color);
            }

            .toolbar button:hover {
                opacity: 0.9;
            }

            .toolbar .left-tools {
                display: flex;
                align-items: center;
                gap: 5px;
            }

            .toolbar .right-tools {
                display: flex;
                gap: 5px;
            }

            .main-content {
                display: flex;
                flex: 1;
                overflow: hidden;
                text-align: center;
            }

            .sidebar {
                width: 200px;
                background-color: #fff;
                border-right: 1px solid #ddd;
                overflow-y: auto;
                display: none; /* Toggleable */
            }

            .sidebar ul {
                list-style: none;
            }

            .sidebar ul li {
                padding: 10px;
                cursor: pointer;
                border-bottom: 1px solid #ddd;
            }

            .sidebar ul li:hover {
                background-color: #f5f5f5;
            }

            .sidebar ul li canvas {
                max-width: 100%;
                height: auto;
            }

            .viewer {
                flex: 1;
                overflow: auto;
                background-color: #d4d4d6;
            }

            .pageCanvas {
                user-select: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
            }

            .logo-container {
                margin-bottom: 20px;
                text-align: center;
            }

            .logo {
                color: white;
                font-size: 2.5rem;
                background-color: #4caf50;
                padding: 10px 20px;
                border-radius: 10px;
                position: relative;
            }

            .strawberry {
                position: absolute;
                top: -20px;
                right: -20px;
                font-size: 1.5rem;
            }

            .form-container {
                background: white;
                padding: 20px;
                border-radius: 10px;
                width: 100%;
                max-width: 600px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }

            h1 {
                font-size: 1.3rem;
                margin-bottom: 20px;
                color: #333;
            }

            .loading-container {
                display: flex;
                justify-content: center;
                flex-direction: column;
                align-items: center;
                gap: 4px;
            }

            .loading {
                display: none;
                margin-top: 10px;
                font-size: 1.7rem;
                color: #4b4b4b;
            }

            .form-group {
                margin-bottom: 15px;
            }

            input {
                width: 100%;
                padding: 12px;
                border: 1px solid #ddd;
                border-radius: 5px;
                background: transparent !important;
                font-size: 1rem;
            }

            .zip-city {
                display: flex;
                gap: 15px;
                width: 100%;
            }

            .by-pass {
                display: flex;
                align-items: center;
                gap: 15px;
                width: 100%;
            }

            .zip {
                width: 40%;
            }

            .city {
                width: 60%;
            }

            .button-container {
                display: flex;
                justify-content: flex-end;
                gap: 15px;
                margin-top: 20px;
            }

            button {
                padding: 12px 24px;
                border: none;
                border-radius: 5px;
                font-size: 1rem;
                cursor: pointer;
                transition: opacity 0.3s;
            }

            button:hover {
                opacity: 0.9;
            }

            .back {
                background-color: var(--primary-green);
                color: white;
            }
            .preview,
            .download {
                background-color: var(--primary-green);
                color: white;
                text-wrap: nowrap;
                flex: 1;
            }

            .submit {
                background-color: #6eab70;
                color: white;
                opacity: 0.6;
                pointer-events: none;
            }
            .submit.active {
                background-color: #4caf50;
                opacity: 1;
                pointer-events: auto;
            }

            .error-container {
                display: none;
                flex-direction: column;
                align-items: center;
                padding: 20px;
                background: white;
                border-radius: 10px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }

            .title-success {
                font-size: 1.25rem;
                color: #000;
                margin-bottom: 0.625rem;
                font-weight: 300;
                text-align: center;
            }

            .hidden {
                display: none;
            }
            input.error {
                border: 1px solid red;
            }
            .spinner {
                border: 8px solid rgba(0, 0, 0, 0.1);
                border-top: 8px solid #323131;
                border-radius: 50%;
                width: 6rem;
                height: 6rem;
                animation: spin 1s linear infinite;
                display: none;
            }
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            .success-container {
                display: none;
                font-weight: bold;
                align-items: center;
                flex-direction: column;
            }

            .icon {
                width: 10.5rem;
                height: 10.5rem;
            }

            .toast {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 5px;
                color: white;
                display: none;
                z-index: 1000;
            }

            .toast.success {
                background-color: var(--primary-green);
            }

            .toast.error {
                background-color: white;
                color: #000;
            }

            .form-group input:disabled {
                background-color: #f5f5f5 !important;
                border: 1px solid #ddd !important;
                color: #aaa;
                cursor: not-allowed;
            }

            input:focus {
                outline: none;
            }
            #sendEmailInput:disabled {
                background-color: #e0e0e0 !important;
                color: #777; 
                cursor: not-allowed;
            }

            #sendEmailForm button:disabled {
                background-color: #bdbdbd !important; 
                color: #fff; 
                cursor: not-allowed !important;
                opacity: 1; 
            }
            @media (max-width: 480px) {
                .form-container {
                    padding: 15px;
                }
            }
        </style>
    </head>
    <body id="root">
        <div class="loading-container">
            <div class="spinner"></div>
            <div class="loading">Wird verarbeitet...</div>
        </div>

        <div class="success-container" style="width: 100%; max-width: 1300px; height: 100%; border-radius: 0; padding: 8px;">
            <div class="container">
                <div class="main-content">
                    <div class="sidebar" id="sidebar"  >
                        <ul id="thumbnailList"  style="display: none;"></ul>
                    </div>
                    <div class="viewer">
                    </div>
                </div>
            </div>
            <!-- Email + Download -->
            <form id="sendEmailForm" style="display: flex; gap: 10px; width: 100%; margin-top: 10px; align-items: center;" novalidate>
                <button type="button" id="downloadSuccessBtn" style="background: #4caf50; color: white; border: none; border-radius: 5px; padding: 10px 14px; cursor: pointer; white-space: nowrap; height: 100%;">
                    <i class="fa-solid fa-download"></i>
                </button>
                <input type="email" id="sendEmailInput" placeholder="Email" required pattern="^[^\s@]+@[^\s@]+\.[^\s@]{2,}$" />
                <button type="submit" style="padding: 10px 14px; background: #4caf50; color: white; border: none; border-radius: 5px; cursor: pointer; white-space: nowrap; height: 100%;">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </form>
        </div>

        <div class="form-container" style="display: none;">
            <h1>Rechnungsangaben</h1>
            <form id="addressForm" class="form" autocomplete="off" novalidate>
                <div class="form-group">
                    <input type="text" id="firstName" placeholder="Vorname" required />
                </div>

                <div class="form-group">
                    <input type="text" id="lastName" placeholder="Nachname" required />
                </div>

                <div class="form-group">
                    <input type="text" id="address" placeholder="Straße und Hausnummer" required />
                </div>
                <div class="form-group zip-city">
                    <input type="text" pattern="[0-9]*" id="postCode" placeholder="Postleitzahl" class="zip" required min="0" step="1" />
                    <input type="text" id="city" placeholder="Stadt" class="city" required />
                </div>
                <div class="form-group">
                    <input type="email" id="email" placeholder="Email" pattern="^[^\s@]+@[^\s@]+\.[^\s@]{2,}$" />
                </div>
                <div class="form-group by-pass">
                    <label class="checkbox-title">
                        <input style="width: unset;" type="checkbox" id="isBypass" />
                        <span style="margin-left: 8px;">Keine Angaben machen, überspringen</span>
                    </label>
                </div>

                <div class="button-container">
                    <button type="submit" class="submit">Fortfahren</button>
                </div>
            </form>
        </div>
        <div class="error-container" style="display: none;">
            <div class="icon-wrapper">
                <svg class="icon" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                    <rect width="512" height="512" fill="url(#pattern0)" />
                    <defs>
                        <pattern id="pattern0" patternContentUnits="objectBoundingBox" width="1" height="1">
                            <use xlink:href="#image0_2273_8" transform="scale(0.00195312)" />
                        </pattern>
                        <image
                            id="image0_2273_8"
                            width="512"
                            height="512"
                        />
                    </defs>
                </svg>
            </div>

            <h1 class="title-success">Dieser Inhalt ist nicht mehr verfügbar!</h1>
        </div>
        <!-- Toast notification -->
        <div class="toast"></div>

        <script>
            pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";

            const api = axios.create({
                baseURL: "https://file-dev.raeco.de/v1",
                timeout: 5000,
                headers: { "Content-Type": "application/json" },
            });

            let qrcode = "";
            let fileBlob = null;
            let fileName = "hoa_don.pdf";
            let emailParam = "";
            let pdfDoc = null;
            let currentScale = 1.0;
            let currentTx = 0;
            let currentTy = 0;
            let pdfContainer = null;
            let pageContainer = null;
            let isPinching = false;
            let isPanning = false;
            let isDragging = false;
            let initialDist = 0;
            let initialScale = 1;
            let initialTx = 0;
            let initialTy = 0;
            let initialRelX = 0;
            let initialRelY = 0;
            let startX = 0;
            let startY = 0;
            let startMouseX = 0;
            let startMouseY = 0;

            function getDistance(touch1, touch2) {
                const dx = touch2.clientX - touch1.clientX;
                const dy = touch2.clientY - touch1.clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }

            async function renderAllPages() {
                const viewer = document.querySelector('.viewer');
                viewer.innerHTML = '';
                pdfContainer = document.createElement('div');
                pdfContainer.id = 'pdfContainer';
                pdfContainer.style.position = 'relative';
                pdfContainer.style.width = '100%';
                pdfContainer.style.height = 'auto';
                viewer.appendChild(pdfContainer);

                pageContainer = document.createElement('div');
                pageContainer.id = 'pageContainer';
                pageContainer.style.position = 'relative';
                pageContainer.style.top = '0';
                pageContainer.style.left = '0';
                pageContainer.style.transformOrigin = '0 0';
                pdfContainer.appendChild(pageContainer);

                const renderScale = 1.5;
                const renderPromises = [];
                for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                    const pageDiv = document.createElement('div');
                    pageDiv.style.display = 'block';
                    pageDiv.style.margin = '10px auto';
                    pageDiv.style.textAlign = 'center';
                    const canvas = document.createElement('canvas');
                    canvas.id = `pageCanvas_${pageNum}`;
                    canvas.className = 'pageCanvas';
                    pageDiv.appendChild(canvas);
                    pageContainer.appendChild(pageDiv);

                    const renderPromise = pdfDoc.getPage(pageNum).then((page) => {
                        const viewport = page.getViewport({ scale: renderScale });
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        const ctx = canvas.getContext('2d');
                        return page.render({ canvasContext: ctx, viewport }).promise;
                    });
                    renderPromises.push(renderPromise);
                }

                await Promise.all(renderPromises);

                pageContainer.style.transform = `translate(${currentTx}px, ${currentTy}px) scale(${currentScale})`;
            }

            function generateThumbnails() {
                const sidebar = document.getElementById('sidebar');
                const ul = document.getElementById('thumbnailList');
                ul.innerHTML = '';
                // sidebar.style.display = 'block';

                for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                    const li = document.createElement('li');
                    const thumbCanvas = document.createElement('canvas');
                    li.appendChild(thumbCanvas);
                    li.style.cursor = 'pointer';
                    li.onclick = () => {
                        const targetCanvas = document.getElementById(`pageCanvas_${pageNum}`);
                        if (targetCanvas) {
                            targetCanvas.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    };
                    ul.appendChild(li);

                    pdfDoc.getPage(pageNum).then((page) => {
                        const unscaledViewport = page.getViewport({ scale: 1 });
                        const thumbScale = 150 / unscaledViewport.width;
                        const thumbViewport = page.getViewport({ scale: thumbScale });
                        thumbCanvas.width = thumbViewport.width;
                        thumbCanvas.height = thumbViewport.height;
                        const ctx = thumbCanvas.getContext('2d');
                        page.render({ canvasContext: ctx, viewport: thumbViewport });
                    });
                }
            }

            document.addEventListener("DOMContentLoaded", async function () {
                const urlParams = new URLSearchParams(window.location.search);
                qrcode = urlParams.get("qrcode");
                emailParam = urlParams.get("email") || "";

                if (qrcode) {
                    qrcode = qrcode.replace(/ /g, "+");
                }

                if (qrcode) {
                    try {
                        const response = await api.post("/invoice/scan-qrcode", { qrcode });
                        if (response.data && response.data.data.state) {
                            switch (response.data.data.state) {
                                case 2:
                                case 3:
                                    await checkStatus();
                                    break;
                                default:
                                    showForm();
                            }
                        } else {
                            showForm();
                        }
                    } catch (error) {
                        showError();
                    }
                } else {
                    showError();
                }

                // Touch and mouse events for pan and zoom
                document.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 1 && pdfContainer) {
                        isPanning = true;
                        const touch = e.touches[0];
                        startX = touch.clientX - currentTx;
                        startY = touch.clientY - currentTy;
                    } else if (e.touches.length === 2 && pdfDoc && pdfContainer) {
                        isPinching = true;
                        const t0 = e.touches[0];
                        const t1 = e.touches[1];
                        initialDist = getDistance(t0, t1);
                        initialScale = currentScale;
                        initialTx = currentTx;
                        initialTy = currentTy;
                        const centerX = (t0.clientX + t1.clientX) / 2;
                        const centerY = (t0.clientY + t1.clientY) / 2;
                        const rect = pdfContainer.getBoundingClientRect();
                        initialRelX = centerX - rect.left;
                        initialRelY = centerY - rect.top;
                    }
                }, { passive: false });

                document.addEventListener('touchmove', (e) => {
                    if (isPanning && e.touches.length === 1 && pageContainer) {
                        e.preventDefault();
                        const touch = e.touches[0];
                        currentTx = touch.clientX - startX;
                        currentTy = touch.clientY - startY;
                        pageContainer.style.transform = `translate(${currentTx}px, ${currentTy}px) scale(${currentScale})`;
                    } else if (isPinching && e.touches.length === 2 && pageContainer) {
                        e.preventDefault();
                        const t0 = e.touches[0];
                        const t1 = e.touches[1];
                        const currentDist = getDistance(t0, t1);
                        if (initialDist === 0) return;
                        const deltaScale = currentDist / initialDist;
                        let targetScale = initialScale * deltaScale;
                        targetScale = Math.max(0.5, Math.min(3.0, targetScale));
                        const centerX = (t0.clientX + t1.clientX) / 2;
                        const centerY = (t0.clientY + t1.clientY) / 2;
                        const rect = pdfContainer.getBoundingClientRect();
                        const currentRelX = centerX - rect.left;
                        const currentRelY = centerY - rect.top;
                        const dScale = targetScale / initialScale;
                        let zoomTx = initialRelX * (1 - dScale) + initialTx * dScale;
                        let zoomTy = initialRelY * (1 - dScale) + initialTy * dScale;
                        const deltaPanX = currentRelX - initialRelX;
                        const deltaPanY = currentRelY - initialRelY;
                        currentTx = zoomTx + deltaPanX;
                        currentTy = zoomTy + deltaPanY;
                        currentScale = targetScale;
                        pageContainer.style.transform = `translate(${currentTx}px, ${currentTy}px) scale(${currentScale})`;
                    }
                }, { passive: false });

                document.addEventListener('touchend', (e) => {
                    if (e.touches.length < 2) {
                        isPinching = false;
                        initialDist = 0;
                    }
                    if (e.touches.length === 0) {
                        isPanning = false;
                    }
                }, { passive: false });

                // Mouse pan
                document.addEventListener('mousedown', (e) => {
                    if (e.button === 0 && pdfContainer) {
                        isDragging = true;
                        startMouseX = e.clientX - currentTx;
                        startMouseY = e.clientY - currentTy;
                        e.preventDefault();
                    }
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging && pageContainer) {
                        currentTx = e.clientX - startMouseX;
                        currentTy = e.clientY - startMouseY;
                        pageContainer.style.transform = `translate(${currentTx}px, ${currentTy}px) scale(${currentScale})`;
                        e.preventDefault();
                    }
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });

                // Wheel zoom at mouse position
                document.addEventListener('wheel', (e) => {
                    if (e.ctrlKey && pdfContainer && pageContainer) {
                        e.preventDefault();
                        const rect = pdfContainer.getBoundingClientRect();
                        const relX = e.clientX - rect.left;
                        const relY = e.clientY - rect.top;
                        const factor = e.deltaY * -0.001;
                        let targetScale = currentScale * (1 + factor);
                        targetScale = Math.max(0.5, Math.min(3.0, targetScale));
                        const dScale = targetScale / currentScale;
                        let newTx = relX * (1 - dScale) + currentTx * dScale;
                        let newTy = relY * (1 - dScale) + currentTy * dScale;
                        currentTx = newTx;
                        currentTy = newTy;
                        currentScale = targetScale;
                        pageContainer.style.transform = `translate(${currentTx}px, ${currentTy}px) scale(${currentScale})`;
                    }
                }, { passive: false });
            });

            function showForm() {
                document.querySelector(".form-container").style.display = "block";
                document.querySelector(".loading").style.display = "none";
                document.querySelector(".spinner").style.display = "none";
            }

            function showError() {
                document.querySelector(".form-container").style.display = "none";
                document.querySelector(".error-container").style.display = "flex";
            }

            const form = document.getElementById("addressForm");
            const submitButton = document.querySelector(".submit");
            const termsCheckbox = document.getElementById("isBypass");

            termsCheckbox.addEventListener("change", () => {
                const formInputs = form.querySelectorAll("input:not(#isBypass)");
                if (termsCheckbox.checked) {
                    formInputs.forEach((input) => (input.disabled = true));
                    submitButton.classList.add("active");
                } else {
                    formInputs.forEach((input) => (input.disabled = false));
                    const firstName = document.getElementById("firstName").value.trim();
                    const lastName = document.getElementById("lastName").value.trim();
                    const address = document.getElementById("address").value.trim();
                    const postCode = document.getElementById("postCode").value.trim();
                    const city = document.getElementById("city").value.trim();
                    if (firstName && lastName && address && postCode && city) {
                        submitButton.classList.add("active");
                    } else {
                        submitButton.classList.remove("active");
                    }
                }
            });

            form.addEventListener("input", () => {
                if (!termsCheckbox.checked) {
                    const firstName = document.getElementById("firstName").value.trim();
                    const lastName = document.getElementById("lastName").value.trim();
                    const address = document.getElementById("address").value.trim();
                    const postCode = document.getElementById("postCode").value.trim();
                    const city = document.getElementById("city").value.trim();
                    if (firstName && lastName && address && postCode && city) {
                        submitButton.classList.add("active");
                    } else {
                        submitButton.classList.remove("active");
                    }
                }
            });

            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                let isValid = true;
                const inputs = form.querySelectorAll("input[required], input[pattern], input[min]");

                inputs.forEach((input) => {
                    if (!input.checkValidity()) {
                        input.classList.add("error");
                        if (isValid) {
                            input.focus(); // focus vào field đầu tiên lỗi
                        }
                        isValid = false;
                    } else {
                        input.classList.remove("error");
                    }
                });

                if (!isValid) {
                    return;
                }
                form.style.display = "none";
                document.querySelector(".form-container").style.display = "none";
                document.querySelector(".loading-container").style.display = "flex";
                const formData = {
                    firstName: document.getElementById("firstName").value,
                    lastName: document.getElementById("lastName").value,
                    postCode: document.getElementById("postCode").value,
                    city: document.getElementById("city").value,
                    address: document.getElementById("address").value,
                    email: document.getElementById("email").value,
                    isBypass: termsCheckbox.checked,
                    qrcode: qrcode,
                };

                try {
                    const response = await api.post("/invoice/submit-form", formData);
                    if (response.status === 200 || response.status === 201) {
                        form.reset();
                        termsCheckbox.checked = false;
                        submitButton.classList.remove("active");
                        await checkStatus();

                        // Cập nhật URL với email param
                        if (formData.email && !termsCheckbox.checked) {
                            const newUrl = new URL(window.location.href);
                            newUrl.searchParams.set("email", formData.email);
                            window.history.replaceState({}, "", newUrl);
                            emailParam = formData.email;
                        }
                    } else {
                        console.error("Error saving address.");
                    }
                } catch (error) {
                    console.error("Submit Error:", error);
                }
            });

            function showToast(message, type = "success") {
                const toast = document.querySelector(".toast");
                toast.textContent = message;
                toast.className = "toast " + type;
                toast.style.display = "block";
                setTimeout(() => {
                    toast.style.display = "none";
                }, 3000);
            }

            async function checkStatus() {
                document.querySelector(".loading-container").style.display = "flex";
                document.querySelector(".form-container").style.display = "none";
                document.querySelector(".loading").style.display = "block";
                document.querySelector(".spinner").style.display = "block";

                const firstCheck = await api.post("/invoice/check-status", { qrcode });
                if (firstCheck.data && firstCheck.data.data) {
                    await fetchFileBlob(firstCheck.data.data);
                    document.querySelector(".loading-container").style.display = "none";
                    document.querySelector(".success-container").style.display = "flex";

                    const sendEmailForm = document.getElementById("sendEmailForm");
                    const sendEmailInput = document.getElementById("sendEmailInput");

                    if (emailParam) {
                        // Đã có email trong URL => disable form
                        sendEmailInput.value = emailParam;
                        sendEmailInput.disabled = true;
                        sendEmailForm.querySelector("button[type=submit]").disabled = true;
                    } else {
                        sendEmailForm.style.display = "flex";
                    }
                    return;
                }

                // Polling
                const intervalId = setInterval(async () => {
                    try {
                        const response = await api.post("/invoice/check-status", { qrcode });
                        if (response.data && response.data.result === false) {
                            clearInterval(intervalId);
                            document.querySelector(".loading-container").style.display = "none";
                            document.querySelector(".error-container").style.display = "flex";
                            return;
                        }

                        if (response.data && response.data.data) {
                            clearInterval(intervalId);
                            await fetchFileBlob(response.data.data);
                            document.querySelector(".loading-container").style.display = "none";
                            document.querySelector(".success-container").style.display = "flex";
                            const sendEmailForm = document.getElementById("sendEmailForm");
                            const sendEmailInput = document.getElementById("sendEmailInput");

                            if (emailParam) {
                                // Đã có email trong URL => disable form
                                sendEmailInput.value = emailParam;
                                sendEmailInput.disabled = true;
                                sendEmailForm.querySelector("button[type=submit]").disabled = true;
                            } else {
                                sendEmailForm.style.display = "flex";
                            }
                        }
                    } catch (error) {
                        console.error("Error checking status:", error);
                    }
                }, 5000);
            }

            async function fetchFileBlob(data) {
                try {
                    const response = await api.get(`/file/download/${data}`, {
                        responseType: "blob",
                    });
                    fileBlob = new Blob([response.data], { type: "application/pdf" });

                    const pdfData = await fileBlob.arrayBuffer();
                    pdfDoc = await pdfjsLib.getDocument({ data: pdfData }).promise;

                    const isMobile = window.innerWidth <= 768;
                    const firstPagePromise = pdfDoc.getPage(1);
                    const firstPage = await firstPagePromise;
                    const unscaledViewport = firstPage.getViewport({ scale: 1 });
                    const viewerWidth = document.querySelector('.viewer').clientWidth;
                    let logicalScale = isMobile ? (viewerWidth / unscaledViewport.width) * 0.95 : 1.0;
                    const renderScale = 1.5;
                    currentScale = logicalScale / renderScale;
                    currentTx = 0;
                    currentTy = 0;

                    await renderAllPages();
                    generateThumbnails();

                    const contentDisposition = response.headers["content-disposition"];
                    if (contentDisposition) {
                        const fileNameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
                        if (fileNameMatch && fileNameMatch[1]) {
                            fileName = fileNameMatch[1];
                        }
                    }
                } catch (error) {
                    console.error("Fetch blob error:", error);
                }
            }

            document.getElementById("downloadSuccessBtn").addEventListener("click", () => {
                if (fileBlob) {
                    const url = window.URL.createObjectURL(fileBlob);
                    const link = document.createElement("a");
                    link.href = url;
                    link.setAttribute("download", fileName);
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                }
            });

            // Gửi email
            document.getElementById("sendEmailForm")?.addEventListener("submit", async (e) => {
                e.preventDefault();
                const sendEmailForm = document.getElementById("sendEmailForm");
                const email = document.getElementById("sendEmailInput").value.trim();
                let isValid = true;
                const inputs = sendEmailForm.querySelectorAll("input[required], input[pattern]");

                inputs.forEach((input) => {
                    if (!input.checkValidity()) {
                        input.classList.add("error");
                        if (isValid) {
                            input.focus(); // focus vào field đầu tiên lỗi
                        }
                        isValid = false;
                    } else {
                        input.classList.remove("error");
                    }
                });

                if (!isValid) {
                    return;
                }

                try {
                    const response = await api.post("/invoice/send-to-email", { qrcode, email });
                    if (response.status === 200 || response.status === 201) {
                        showToast("Gửi email thành công!", "success");

                        // Gắn email vào URL để disable form
                        const newUrl = new URL(window.location.href);
                        newUrl.searchParams.set("email", email);
                        window.history.replaceState({}, "", newUrl);
                        emailParam = email;

                        const sendEmailInput = document.getElementById("sendEmailInput");
                        sendEmailInput.value = email;
                        sendEmailInput.disabled = true;
                        document.querySelector("#sendEmailForm button[type=submit]").disabled = true;
                    } else {
                        showToast("Không thể gửi email.", "error");
                    }
                } catch (err) {
                    console.error("Send email error:", err);
                    showToast("Có lỗi khi gửi email.", "error");
                }
            });
        </script>
    </body>
</html>